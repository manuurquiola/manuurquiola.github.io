<html>
   <head>
       <title>Paint with micro:bit!</title>
       <script type="text/javascript" src="./microbit.umd.js"></script>
   </head>
   <body>
		<div >
			<img src="./ceibal-microbit.png" alt="Plan Ceibal logo and micro:bit logo" style="max-width:30%; max-height:30%">
			<strong style="font-size:30px; font-family:sans-serif; valign:middle">Paint with micro:bit!</strong>
			&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
			<button id="find" style="font-size:30px; font-family:sans-serif; border:4px solid black; padding:5px 10px">Search device</button>
			<strong id="estado" style="color:red; font-size:30px; font-family:sans-serif">Disconnected</strong>
			<p style="font-size:30px; font-family:sans-serif"> Press button A to paint and button B to change color. </p>
		</div>
		<canvas id="drawingCanvas" width="1163" height="800" style="border: 4px solid black"></canvas>
        <script>
			var canvas = document.getElementById("drawingCanvas");
			var ctx = canvas.getContext("2d");
			ctx.fillStyle = "#FF0000";
			function cambioColor(estadoB) {
				if (estadoB == 1) {
					indice = (indice + 1) % 8;
				}
			}
			function actualizoA(Astate) {
				Abutton= Astate;
			}
			function dibujar(x, y) {
				if (Abutton != 0) {
					if (0 > X) {
						X = 0;
					} else {
						if (X > 1163) {
							X = 1163;
						} else {
							X = X + x*10;
						}
					}
					if (0 > Y) {
						Y = 0;
					} else {
						if (Y > 800) {
							Y = 800;
						} else {
							Y = Y + y*10;
						}
					}
					ctx.fillStyle = Color[indice];
					ctx.beginPath();
					ctx.arc(X, Y, 15, 0, 2 * Math.PI, false);
					ctx.stroke();
					ctx.fill();
				}
			}
			var Color = ['red' , 'green', 'blue', 'Brown', 'Cyan', 'Fuchsia', 'Yellow', 'Violet'];
			var indice = 0;
			var Abutton = 0;
			var Bbutton = 0;
			var X = 0;
			var Y = 0;
			var W = 300;
			var accel;        
            const eventHandler = event => dibujar(event.detail.x , event.detail.y);
			const eventHandler2 = event => actualizoA(event.detail);
			const eventHandler3 = event => cambioColor(event.detail);
            document.getElementById("find").onclick = async () => {
                const device = await microbit.requestMicrobit(window.navigator.bluetooth);
                if (device) {
                    const services = await microbit.getServices(device);
                    if (services.deviceInformationService) {
						document.getElementById("estado").innerHTML = "Connected";
						document.getElementById("estado").style.color = 'green';
                    }
                    if (services.buttonService) {
                        services.buttonService.addEventListener("buttonastatechanged", eventHandler2 );
                        services.buttonService.addEventListener("buttonbstatechanged", eventHandler3 );
                    }
                    if (services.accelerometerService) {
                        await services.accelerometerService.setAccelerometerPeriod(10);
                       	services.accelerometerService.addEventListener("accelerometerdatachanged", eventHandler)
                    }
                }
            }
        </script>
    </body>
</html>
